<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles/admin.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Administrador</title>
  </head>

  <body>
    <div id="criar_usuario" class="criar_usuario">
      <div class="container">
        <p>Nome do novo usuário</p>
        <input id="input_nome" type="text" placeholder="nome" />
        <p>Sobrenome do novo usuário</p>
        <input id="input_sobrenome" type="text" placeholder="sobrenome" />
        <p>Email do novo usuário</p>
        <input id="input_email" type="text" placeholder="email" />
        <p>Senha do novo usuário</p>
        <input id="input_senha" type="password" placeholder="senha" />
        <p>Confirme a senha do novo usuário</p>
        <input
          id="input_confirmar_senha"
          type="password"
          placeholder="confirmar senha"
        />
        <p>Telefone do novo usuário</p>
        <input id="input_telefone" type="text" placeholder="telefone" />
        <div class="buttons">
          <button onclick="fnCriarNovoUsuario()">Criar novo usuário</button>
          <button onclick="fnEsconderFormulario()">Cancelar</button>
        </div>
      </div>
    </div>
    <div class="header">
      <div class="container">
        <h1>S.I.G</h1>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="post.html">Artigos</a></li>
          <li><a id="a_login" href="admin.html"></a></li>
          <li id="li_sair"><a onclick="fnDeslogar()">Sair</a></li>
        </ul>
      </div>
    </div>

    <div class="content">
     <div class="container">

       <div class="center">
         <button onclick="fnMostrarUsuarios()" id="btnMostrarUsuario">Mostrar usuários cadastrados</button>
       </div>
       <section id="usuariosAtivos">
        <div class="center">
          <button onclick="fnMostrarFormulario()">Cadastrar novo usuário</button>
        </div>
       </section>
       <div class="center">
        <button onclick="fnMostrarUsuariosInativos()" id="btnMostrarUsuario_inativos">Mostrar usuários inativos</button>
      </div>
       <section id="usuariosInativos"></section>
     </div>

      <div id="graficos" class="graficos">
        <div class="grafico">
          <canvas id="chartUsuariosInativosxAtivos"></canvas>
        </div>
        <div class="grafico">
          <canvas id="chartPostagensxComentarios"></canvas>
        </div>
        <div class="grafico">
          <canvas id="chartUsuariosRecorrentes"></canvas>
        </div>
        <div class="grafico">
          <canvas id="chartUsuariosxComentarios"></canvas>
        </div>
      </div>

      <div class="graficos">
        
        <div class="grafico">
          <canvas id=""></canvas>
        </div>
        <div class="grafico">
          <canvas id=""></canvas>
        </div>
      </div>
    </div>
  </body>
</html>
<script src="js/chart.js"></script>
<script>
  /* Código revisado e comentado em 06/12/21 por: Vinicius Oliveira*/

  // Criação de uma variavel de armazenamento local, essencial para o sistema de sessão
  var Armazenamento_local = localStorage;
  // Obtendo o valor da chave "logado" no armazenamento local. Que é atribuído como verdadeiro caso o usuário tenha feito login
  var admin = Armazenamento_local.getItem('admin');

  // Por mais que seja definido como "true", a variavel armazenada no armazenamento local é convertida pra string, sendo assim, é necessário fazer a conversão para valor booleano
  if (admin == 'true') {
    admin = true;
  } else {
    admin = false;
  }

  // Caso o usuário seja admin, transcorrer as funções da página normalmente
  if (admin) {
    function fnModificarDados(id) {
      Armazenamento_local.setItem('id_modificacao', id);
      window.location = 'modificar.html';
    }

    // Modificando a navbar com o nome do administrador
    a_login.innerHTML = `${Armazenamento_local.getItem("nome_usuario")}`;

    // A primeira requisição dessa página é listar todos os usuários que não são administradores e que não estão com a conta desativada.
    fetch('/usuarios/listar', {
      method: 'GET',
      mode: 'cors'
    })
      .then(function (resposta) {
        resposta
          .json()
          .then(function (resultado) {
            // A partir da resposta dessa requisição, para cada elemento (conta de usuário) que retornar, fazer uma div para ele e completa-lá com suas informações
            resultado.forEach(element => {
              console.log(element.ultimoAcessoUsuario);
              usuariosAtivos.innerHTML += `<div class="card">
                    <p>Nome completo do usuário: ${element.nomeUsuario} ${
                element.sobrenomeUsuario
              }</p>
                    <p>Email do usuário: ${element.emailUsuario}</p>
                    <p>Último acesso: ${element.ultimoAcessoUsuario.substring(8,10)}/${element.ultimoAcessoUsuario.substring(5,7)}/${element.ultimoAcessoUsuario.substring(0,4)} às ${element.ultimoAcessoUsuario.substring(11,13)}:${element.ultimoAcessoUsuario.substring(14, 16)}</p>
                    <p id="paragrafoAcesso"></p>
                        <button onclick="fnModificarDados(${
                          element.idUsuario
                        })">Modificar dados</button>
                    </div>`;
            });
          })
          .catch(function (erro) {
            console.log(erro);
          });
      })
      .catch(function (erro) {
        console.log(erro);
      });

    // A função deslogar define a chave "logado" como falsa e deixa o id do usuário como nulo. Logo após redireciona o usuário para a tela inicial do site.
    function fnDeslogar() {
      Armazenamento_local.setItem("id", null);
        Armazenamento_local.setItem("id_modificacao", null);
        Armazenamento_local.setItem("nome_usuario", null);
        Armazenamento_local.setItem("sobrenome_usuario", null);
        Armazenamento_local.setItem("email_usuario", null);
        Armazenamento_local.setItem("telefone_usuario", null);
        Armazenamento_local.setItem("logado", false);
        Armazenamento_local.setItem("admin", false);
        window.location = "index.html";
    }

    // A função de criar novo usuário, basicamente é a mesma da página "cadastro.html"
    function fnCriarNovoUsuario() {
      var email = input_email.value;

      fetch('/usuarios/verificar_email', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          email: email.toLowerCase()
        })
      })
        .then(function (resultado) {
          resultado
            .json()
            .then(function (dados) {
              if (dados.length == 0) {
                var nome = input_nome.value.toLowerCase();
                var sobrenome = input_sobrenome.value.toLowerCase();
                var email = input_email.value.toLowerCase();
                var senha = input_senha.value.toLowerCase();
                var confirmacao_senha = input_confirmar_senha.value.toLowerCase();
                var telefone = input_telefone.value;

                if(nome == "" || sobrenome == "" || email == "" || senha == "" || telefone == ""){
                  alert("Preencha todos os campos!!");
                }else if(senha != confirmacao_senha){
                  alert("As senhas não correspondem!");
                }else if(senha.length < 8){
                  alert("A senha deve ter mais de 8 caracteres");
                }
                else{
                fetch('/usuarios/cadastrar', {
                  method: 'POST',
                  headers: {
                    // Informando que o tipo de corpo que será enviado será JSON
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    nome: nome,
                    sobrenome: sobrenome,
                    email: email,
                    senha: senha,
                    telefone: telefone                    
                  })
                })
                  .then(function (resposta) {
                    console.log('resposta: ', resposta);
                    if (resposta.ok) {
                      window.alert('Cadastro realizado com sucesso!');
                      window.location = 'admin.html';
                    } else {
                      throw 'Houve um erro ao tentar realizar o cadastro!';
                    }
                  })
                  .catch(function (erro) {
                    console.log(erro);
                  });
                }
              } else {
                alert('Email já cadastrado.');
              }
            })
            .catch(function (erro) {
              console.log('Deu bomba no JSON');
            });
        })
        .catch(function (erro) {
          console.log(erro);
        });
    }

    // Esconde o form de cadastro de novos usuários
    criar_usuario.style.display = 'none';

    // Mostra o form de cadastro de novos usuários
    function fnMostrarFormulario() {
      criar_usuario.style.display = 'block';
    }

    // Esconde o form de cadastro de novos usuários
    function fnEsconderFormulario() {
      criar_usuario.style.display = 'none';
    }
  }
  // Se o usuário não for administrador, enviar ele para a tela de perfil
  else {
    window.location = 'perfil.html';
  }

  usuariosAtivos.style.display = 'none';
  function fnMostrarUsuarios() {
    if (usuariosAtivos.style.display == 'none') {
      usuariosAtivos.style.display = 'flex';
      btnMostrarUsuario.innerHTML = 'Esconder usuários cadastrados';
    } else if (usuariosAtivos.style.display == 'flex') {
      usuariosAtivos.style.display = 'none';
      btnMostrarUsuario.innerHTML = 'Mostrar usuários cadastrados';
    }
  }

  usuariosInativos.style.display = 'none';
  function fnMostrarUsuariosInativos() {
    if (usuariosInativos.style.display == 'none') {
      usuariosInativos.style.display = 'flex';
      btnMostrarUsuario_inativos.innerHTML = 'Esconder usuários inativos';
    } else if (usuariosInativos.style.display == 'flex') {
      usuariosInativos.style.display = 'none';
      btnMostrarUsuario_inativos.innerHTML = 'Mostrar usuários inativos';
    }
  }

 
    fetch("/usuarios/listar_usuarios_inativos",{
      method: "GET",
      mode: "cors"
    })
    .then(
      function(resposta){
        resposta.json()
        .then(
          function(dados){
            dados.forEach(element => {
              usuariosInativos.innerHTML +=`
              <div class="card">
                    <p>Nome completo do usuário: ${element.nomeUsuario} ${
                element.sobrenomeUsuario
              }</p>
                    <p>Email do usuário: ${element.emailUsuario}</p>
                    <p>Último acesso: ${element.ultimoAcessoUsuario.substring(8,10)}/${element.ultimoAcessoUsuario.substring(5,7)}/${element.ultimoAcessoUsuario.substring(0,4)} às ${element.ultimoAcessoUsuario.substring(11,13)}:${element.ultimoAcessoUsuario.substring(14, 16)}</p>
                    <p id="paragrafoAcesso"></p>
                        <button onclick="fnReativarConta(${
                          element.idUsuario
                        })">Reativar conta</button>
                    </div>
              `;
            });
            
          }
        )
        .catch( )
      }
    )
    .catch(
      function(erro){
        console.log(erro);
      }
    )
  
      function fnReativarConta(id) {
        var dados = {
          id_usuario: id 
        }
        var confirmacao = prompt("Digite 'REATIVAR' para confirmar a reativação da conta");
        if(confirmacao == "REATIVAR"){
            fetch("/usuarios/reativar_conta", {
            method: "POST",
            headers: {
                // Informando que o tipo de corpo que será enviado será JSON
                "Content-Type": "application/json",
            },
            body: JSON.stringify(dados)
        }).then(function (resposta) {
            console.log("resposta: ", resposta);
            // Caso a requisição seja um sucesso, zerar a váriavel de modificação e redirecionar o administrador de volta á tela de admin
            if (resposta.ok) {
                window.location = "admin.html";
            } else {
                throw ("Houve um erro ao tentar reativar o usuário!");
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
        }else{
            alert("Confirmação malsucedida. Não foi possível realizar a reativação.")
        }   
      }



</script>
