<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro</title>
    <link rel="stylesheet" href="styles/cadastro.css">
</head>

<body>
    <div class="header">
        <div class="container">
            <h1>S.I.G</h1>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="post.html">Artigos</a></li>
                <li><a href="login.html">Login</a></li>
            </ul>
        </div>
    </div>



    <div class="wallpaper">
        <div class="cadastro">
            <div class="form">
                <div class="cadastro-form">
                    <span class="material-icons">Cadastro</span>
                    <input id="input_nome" type="text" placeholder="nome">
                    <input id="input_sobrenome" type="text" placeholder="sobrenome">
                    <input id="input_email" type="text" placeholder="email">
                    <input id="input_senha" type="password" placeholder="senha">
                    <input id="input_confirmar_senha" type="password" placeholder="confirmar senha">
                    <input id="input_telefone" type="text" placeholder="telefone">
                    <button onclick="fnCadastrar()">Cadastrar</button>
                    <p id="erro_p"></p>
                    <p>Já possui conta?<a href="login.html">Logar</a></p>
                </div>
            </div>
        </div>
    </div>
    </div>
</body>

</html>
<script>
    /* Código revisado e comentado em 22/11/21 por: Vinicius Oliveira*/


    // Variável booleana que indica se o email que o usuário vai cadastrar é existente ou não. A principio é true, até que se prove o contrário
    var email_existente = true;
    // Criação de uma variavel de armazenamento local, essencial para o sistema de sessão
    var Armazenamento_local = localStorage;
    // Obtendo o valor da chave "logado" no armazenamento local. Que é atribuído como verdadeiro caso o usuário tenha feito login
    var logado = Armazenamento_local.getItem("logado");

    // Por mais que seja definido como "true", a variavel armazenada no armazenamento local é convertida pra string, sendo assim, é necessário fazer a conversão para valor booleano
    if (logado == "true") {
        logado = true;
    } else {
        logado = false;
    }

    // Caso o usuário esteja logado, ou seja, variavel logado = true, alertar o usuário de que ele não pode se cadastrar, pois já está logado, sendo assim, enviar ele para a index.html
    if (logado) {
        alert('Você já está logado. Deslogue-se para poder efetuar cadastro!');
        window.location = "index.html";
        // Se o usuário não estiver logado (logado = false), são criadas todas as funções da página
    } else {
        /*Essa é a função de cadastro. Em resumo, ela, primeiramente, faz um post no banco com o email que o usuário quer cadastrar para verificar se tal email já existe no banco. Caso já exista, o usuário é informado que o email que ele quer cadastrar já está sendo utilizado. Caso contrário, o email está livre, sendo assim é efetuado o post dentro do banco de dados com as informações que o usuário cadastrou.*/
        function fnCadastrar() {
            // Captura das informações digitadas pelo usuário
            var nome = input_nome.value;
            var sobrenome = input_sobrenome.value;
            var email = input_email.value;
            var senha = input_senha.value;
            var confirmacaoSenha = input_confirmar_senha.value;
            var telefone = input_telefone.value;


            //Validações dos campos
            if (nome == "" || sobrenome == "" || email == "" || senha == "" || confirmacaoSenha == "" || telefone == "") {
                alert("Preencha todos os campos!");
                //Validações caso o campo email esteja no formato incorreto.
            } else if (email.indexOf("@") == -1 && email.indexOf(".") == -1) {
                alert('Email no formato incorreto.');
                // Caso o usuário tenha informado todas as informações de modo correto, fazer oa requisição para verificação do email
            } else if(senha != confirmacaoSenha){
                alert("As senhas devem ser iguais");
            }else {
                // O primeiro a se fazer é capturar o email que o usuário está a cadastrar
                var email = input_email.value;
                // Logo após, é enviado um post para o banco, tendo como corpo esse email que o usuário quer cadastrar em um objeto JSON.
                fetch("/usuarios/verificar_email", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        email: email
                    })
                })
                    // Caso a requisição chegue com êxito, vamos ver o resultado dela
                    .then(
                        function (resultado) {
                            console.log("Resultado:" + resultado.json()
                                .then(function (dados) {
                                    // Caso o tamanho do resultado, oferecido pelo banco seja 0, significa que o email que o usuário digitou não existe no banco ainda, sendo assim, é executada a requisição de cadastro do usuário.
                                    if (dados.length == 0) {
                                        // A requisição de cadastro é simples, primeiramente é moldado o objeto que irá compor o corpo da requisição.
                                        const dados = {
                                            nome: nome,
                                            sobrenome: sobrenome,
                                            email: email,
                                            senha: senha,
                                            telefone: telefone
                                        }
                                        // Logo após a requisição é feita, de modo igual às outras
                                        fetch("/usuarios/cadastrar", {
                                            method: "POST",
                                            headers: {
                                                // Informando que o tipo de corpo que será enviado será JSON
                                                'Content-Type': 'application/json'
                                            },
                                         body: JSON.stringify(dados)
                                        }).then(function (resposta) {

                                            console.log("resposta: ", resposta);
                                            // Caso a requisição seja um sucesso, (resposta 200, ou "ok") alertar o usuário e depois redirecioná-lo para a tela de login. 
                                            if (resposta.ok) {
                                                window.alert("Cadastro realizado com sucesso!");
                                                window.location = "login.html";
                                                // Caso não, exibir um erro à ele
                                            } else {
                                                throw ("Houve um erro ao tentar realizar o cadastro!");
                                            }
                                            // Caso a requisição não de certo, também, enviar um erro
                                        }).catch(function (resposta) {
                                            console.log(`#ERRO: ${resposta}`);
                                        });
                                        // Mas caso o banco retorne algum dado (length > 0), significa que ele "achou" um registro com esse email que o usuário quer cadastrar. Sendo assim, é exibido uma mensagem pro usuário e o cadastro não é efetuado.
                                    } else {
                                        alert("Email já cadastrado.");
                                    }
                                }));
                        }
                    )
                    // Caso a requisição não de certo, também, enviar um erro
                    .catch(
                        function (erro) {
                            console.log("ERRO: ", erro);
                        }
                    )
            }
        }
    }


</script>>