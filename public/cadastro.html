<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro</title>
    <link rel="stylesheet" href="styles/cadastro.css">
</head>

<body>
    <div class="header">
        <div class="container">
            <h1>S.I.G</h1>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="post.html">Artigos</a></li>
                <li><a href="login.html">Login</a></li>
            </ul>
        </div>
    </div>



    <div class="wallpaper">
        <div class="cadastro">
            <div class="form">
                <div class="cadastro-form">
                    <span class="material-icons">Cadastro</span>
                    <input id="input_nome" type="text" placeholder="nome">
                    <input id="input_sobrenome" type="text" placeholder="sobrenome">
                    <input id="input_email" type="text" placeholder="email">
                    <input id="input_senha" type="password" placeholder="senha">
                    <input id="input_confirmar_senha" type="password" placeholder="confirmar senha">
                    <input id="input_telefone" type="text" placeholder="telefone">
                    <button onclick="cadastrar()">Cadastrar</button>
                    <p id="erro_p"></p>
                    <p>Já possui conta?<a href="login.html">Logar</a></p>
                </div>
            </div>
        </div>
    </div>
    </div>
</body>

</html>
<script>

var email_existente = true;
    // Criação de uma variavel de armazenamento local, essencial para o sistema de sessão
    var Armazenamento_local = localStorage;
    // Obtendo o valor da chave "logado" no armazenamento local. Que é atribuído como verdadeiro caso o usuário tenha feito login
    var logado = Armazenamento_local.getItem('logado');

    if (logado == "true") {
        alert('Você já está logado. Deslogue-se para poder efetuar cadastro!');
        window.location = "index.html";
    } else {
        

        // Máscara de validação do telefone
        function fnTelefone() {

            var telefone = input_telefone.value;

            if (telefone.length == 5) {
                input_telefone.value += '-';
            }

            if (telefone.length == 6 && telefone[5] != '-') {
                input_telefone[6] = input_telefone[5];
                input_telefone[5] = '-';
            }
        }

        function limparFormulario() {
            document.getElementById("form_cadastro").reset();
        }



        function cadastrar() {



            var nome = input_nome.value;
            var sobrenome = input_sobrenome.value;
            var email = input_email.value;
            var senha = input_senha.value;
            var confirmacaoSenha = input_confirmar_senha.value;
            var telefone = input_telefone.value;


            // TODO: VERIFICAR AS VALIDAÇÕES QUE ELES ESTÃO APRENDENDO EM ALGORITMOS 
            //Validações caso o campo estja vazio!
            if (nome == "") {
                alert('Preencha o campo nome');
            } else if (sobrenome == "") {
                alert("Preencha o campo sobrenome");
            } else if (email == "") {
                alert("Preencha o campo email");
            } else if (senha == "") {
                alert("Preencha o campo senha")
            } else if (confirmacaoSenha == "") {
                alert("Preencha o campo confirmação senha");
            } else if (telefone == "") {
                alert("Preencha o campo de telefone");
                //Validações caso o campo email esteja no formato incorreto.
            } else if (email.indexOf('@') == -1 && email.indexOf('.') == -1) {
                alert('Email no formato incorreto.');
            } else {
                
        var emailVar = input_email.value;
        fetch("/usuarios/verificar_email", {
            method: "POST",
            headers:{
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                email: emailVar
            })
        })
        .then(
            function(resultado){
                console.log("Resultado:" + resultado.json()
                .then(function(dados){
                if(dados.length == 0){
                const dados = {
                    nome: nome,
                    sobrenome: sobrenome,
                    email: email,
                    senha: senha,
                    telefone: telefone
                }

                fetch("/usuarios/cadastrar", {
                    method: "POST",
                    headers: {
                        // Informando que o tipo de corpo que será enviado será JSON
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                }).then(function (resposta) {

                    console.log("resposta: ", resposta);
                    if (resposta.ok) {
                        window.alert("Cadastro realizado com sucesso!");
                        window.location = "login.html";
                        limparFormulario();
                    } else {
                        throw ("Houve um erro ao tentar realizar o cadastro!");
                    }
                }).catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);
                });
                    
                }else{
                    alert("Email já cadastrado.");
                }
                }));
            }
        )
        .catch(
            function(erro){
                console.log("ERRO: ",erro);
            }
        )
    


            
            }

            

        }
    }

    
</script>>