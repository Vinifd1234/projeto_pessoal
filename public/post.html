<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles/artigos.css" />
  <title>Artigos</title>
</head>

<body>
  <!-- Elemento HTML para a barra de navegação-->
  <header class="header">
    <navbar class="container">
      <h1>S.I.G</h1>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="#">Artigos</a></li>
        <li><a id="nav_login" href="login.html"></a></li>
        <li id="li_sair"><a onclick="fnDeslogar()">Sair</a></li>
      </ul>
    </navbar>
  </header>
  <main>
    <article>
      <p class="textos">S.I.G</p>
      <p class="textos">Lista de postagens</p>
      <section>
        <div id="container" class="container"></div>
      </section>
      <ul id="lista_de_postagens"></ul>
    </article>
  </main>
</body>

</html>
<script>

  // A primeira requisição é um GET que puxará as postagens cadastradas no banco de dados
  fetch('/postagens/listar_postagens', {
    method: 'GET',
    mode: 'cors'
  })
  // Caso a requisição dê certo, é executada uma função com a resposta da requisição
    .then(function (resposta) {
      // Com a resposta do servidor, é executada uma função para tentar a conversão da resposta retornada em JSON
      resposta.json()
      // Caso essa resposta consiga ser convertida em JSON, é executada uma função com o resultado dessa conversão
        .then(function (resultado) {
          console.log(resultado);
          // O método forEach executa uma função para cada elemento dentro de um determinado vetor.
          resultado.forEach(element => {
            // Cada elemento do vetor, apelidado de element, é executada uma função. Sendo assim... (continuar)
            container.innerHTML += `
                <div class="post" onclick="window.location = 'posts/post${element.idPostagem}.html'">
                    <div style='background-image: url("img/posts/${element.nomeCategoria
              }/${element.diretorioImagem}.jpg");' class="fundo"></div>
                    <div class="texto">
                    <h1>${element.tituloPostagem}</h1>
                    <h2>${element.subTituloPostagem}</h2>
                    <p>${element.dtCriacaoPostagem.substring(
                8,
                10
              )}/${element.dtCriacaoPostagem.substring(
                5,
                7
              )}/${element.dtCriacaoPostagem.substring(
                0,
                4
              )} às ${element.dtCriacaoPostagem.substring(
                11,
                13
              )}:${element.dtCriacaoPostagem.substring(14, 16)}</span></p>
                    </div>
                </div>
                
                `;
            /*
                lista_de_postagens.innerHTML += `
                <li>
                <img src = "img/posts/${element.nomeCategoria}/${element.diretorioImagem}.jpg">
                <div class="text">
                        <p id="titulo">${element.tituloPostagem}</p>
                        <p id="Autor">Postado por: ${element.nomeUsuario}</p>
                        <p id="Data">Publicado em: ${element.dtCriacaoPostagem.substring(8, 10)}/${element.dtCriacaoPostagem.substring(5, 7)}/${element.dtCriacaoPostagem.substring(0, 4)} às ${element.dtCriacaoPostagem.substring(11, 13)}:${element.dtCriacaoPostagem.substring(14, 16)}  </p>
                        <p id="Descricao">${element.corpoPostagem}</p>
                        <div>
                            <a href="posts/post${element.idPostagem}.html">Ler artigo</a>
                        </div>
                    </div>
                </li>
                `*/
          });
        })
        .catch(function () {
          /*container.innerHTML = `
                <div class="post">
                    <h1>Não foram encontradas postagens :( </h1>
                    </div>
                `;*/
        });
    })

    // Caso a requisição dê errado, é exibido o erro no console
    .catch(function (erro) {
      console.log(`Erro: ${erro}`);
    })
    

  // Criação de uma variavel de armazenamento local, essencial para o sistema de sessão
  var Armazenamento_local = localStorage;
  // Obtendo o valor da chave "logado" no armazenamento local. Que é atribuído como verdadeiro caso o usuário tenha feito login
  var logado = Armazenamento_local.getItem('logado');

  // Caso o usuário esteja logado, ou seja, variavel logado = true, fazer uma requisição para pegar o nome do usuário
  if (logado == 'true') {
    //Habilita a função de deslogar, caso o usuário esteja logado.
    li_sair.style.display = 'block';
    var id_usuario = Number(Armazenamento_local.getItem('id'));
    const data = { id_usuario: id_usuario };
    fetch('/usuarios/listar1usuario', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    })
      .then(function (resposta) {
        // Com a reposta, redirecionar o botão 'login' para a tela de perfil e mudando o nome para o noem do usuário logado
        resposta.json().then(function (dados) {
          nav_login.href = 'perfil.html';
          nav_login.innerHTML = dados[0].nomeUsuario[0].toUpperCase() + dados[0].nomeUsuario.substring(1);
        });
      })
      .catch(function (erro) {
        console.log(erro);
      });
  } else {
    nav_login.innerHTML = 'Login';
    nav_login.href = 'login.html';
    li_sair.style.display = 'none';
  }

  function fnDeslogar() {
    Armazenamento_local.setItem('logado', false);
    Armazenamento_local.setItem('id', null);
    window.location = 'index.html';
  }
</script>